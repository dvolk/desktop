---
- hosts: localhost
  connection: local

  tasks:
    - name: Install etckeeper
      become: true
      apt:
        update_cache: yes
        cache_valid_time: 36000
        state: latest
        pkg:
          - etckeeper

    - name: Install common packages
      become: true
      apt:
        update_cache: yes
        cache_valid_time: 36000
        state: latest
        pkg:
          - ubuntu-server
          - jq
          - build-essential
          - python3-pip
          - rsync
          - git
          - tmux
          - htop
          - iotop
          - bmon
          - powertop
          - lsof
          - imagemagick
          - ncdu
          - aria2
          - autoconf
          - automake
          - bzip2
          - fzf
          - g++
          - emacs-nox
          - lnav
          - oathtool
          - p7zip
          - parallel
          - rdate
          - sqlite3
          - syncthing
          - tig
          - unace
          - unar
          - unrar
          - unzip
          - valgrind
          - tshark
          - zip
          - apt-file
          - autojump
          - bc
          - clamav
          - cloc
          - cmake
          - cmake-curses-gui
          - curl
          - dict-gcide
          - dictd
          - ranger
          - smartmontools
          - lshw
          - m4
          - mutt
          - openvpn
          - tinc
          - pwgen
          - sshfs
          - strace
          - tree
          - ufw
          - w3m
          - lynx
          - wget
          - whois
          - xdg-user-dirs
          - xz-utils
          - screenfetch
          - net-tools
          - aptitude

    - name: Install python dev packages
      pip:
        name:
          - python-lsp-server
          - isort
          - black

    - name: Install desktop packages
      become: true
      apt:
        update_cache: yes
        cache_valid_time: 36000
        state: latest
        pkg:
          - feh
          - mpv
          - i3
          - i3blocks
          - xclip
          - zathura
          - zathura-djvu
          - gimp
          - xserver-xorg
          - xserver-xorg-input-all
          - xserver-xorg-input-synaptics
          - xserver-xorg-video-all
          - x11-apps
          - x11-utils
          - x11-xkb-utils
          - x11-xserver-utils
          - kitty
          - thunderbird
          - wireshark
          - thunar
          - mousepad
          - rawtherapee
          - cups
          - fbreader
          - fonts-dejavu
          - lxappearance
          - gthumb
          - slock
          - obs-studio
          - remmina
          - xterm
          - scrot
          - sunclock
          - virt-manager
          - webp
          - elementary-xfce-icon-theme
          - lightdm-gtk-greeter
          - lightdm
          - transmission-remote-gtk
          - blueman
      tags:
        - desktop

    - name: Install desktop packages (no recommends)
      become: true
      apt:
        install_recommends: no
        update_cache: yes
        cache_valid_time: 36000
        state: latest
        pkg:
          - barrier
          - libreoffice
          - firefox
          - webext-ublock-origin-firefox
      tags:
        - desktop

    - name: Remove avahi-daemon, gdm3, etc
      become: true
      apt:
        state: absent
        pkg:
          - avahi-daemon
          - gdm3
          - command-not-found
          - motd-news-config

    - name: Download jetbrains font
      ansible.builtin.get_url:
        url: https://github.com/JetBrains/JetBrainsMono/releases/download/v2.242/JetBrainsMono-2.242.zip
        dest: /tmp/JetBrainsMono.zip
        checksum: sha256:4e315b4ef176ce7ffc971b14997bdc8f646e3d1e5b913d1ecba3a3b10b4a1a9f
      tags:
        - desktop

    - name: Create font directory
      file:
        path: ~/.fonts
        state: directory
      tags:
        - desktop

    - name: Extract jetbrains font
      ansible.builtin.unarchive:
        src: /tmp/JetBrainsMono.zip
        dest: ~/.fonts
      tags:
        - desktop

    - name: Create emacs directory
      file:
        path: ~/.emacs.d
        state: directory

    - name: Copy emacs config
      copy:
        src: emacs-config
        dest: ~/.emacs.d/init.el

    - name: touch emacs custom config file
      file:
        dest: ~/.emacs.d/custom.el
        state: touch
        mode: u+rw,g-wx,o-rwx

    - name: Create i3 config directory
      file:
        path: ~/.config/i3
        state: directory
      tags:
        - desktop

    - name: Copy i3 config
      copy:
        src: i3-config
        dest: ~/.config/i3/config
      tags:
        - desktop

    - name: Copy desktop setup script
      copy:
        src: start.sh
        dest: ~/start.sh
      tags:
        - desktop

    - name: Create kitty config directory
      file:
        path: ~/.config/kitty
        state: directory
      tags:
        - desktop

    - name: Copy kitty config
      copy:
        src: kitty-config
        dest: ~/.config/kitty/kitty.conf
      tags:
        - desktop

    - name: Copy kitty theme
      copy:
        src: kitty-theme
        dest: ~/.config/kitty/current-theme.conf
      tags:
        - desktop

    - name: Copy firefox policies
      become: true
      copy:
        src: firefox-policies
        dest: /usr/lib/firefox/distribution/policies.json
      tags:
        - desktop

    - name: Copy gtk2 config
      copy:
        src: gtk2-config
        dest: ~/.gtkrc-2.0
      tags:
        - desktop

    - name: Create gtk3 config directory
      file:
        path: ~/.config/gtk-3.0
        state: directory
      tags:
        - desktop

    - name: Copy gtk3 config
      copy:
        src: gtk3-config
        dest: ~/.config/gtk-3.0/settings.ini
      tags:
        - desktop

    - name: Enable firewall
      community.general.ufw:
        state: enabled
        direction: incoming
        policy: deny
      become: true
      tags:
        - desktop

    - name: Set firewall logging
      community.general.ufw:
        logging: 'on'
      become: true
      tags:
        - desktop

    - name: download adware+malware hosts file
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews-gambling-porn-social/hosts
        dest: /tmp/hosts
      tags:
        - desktop

    - name: insert hostname into /tmp/hosts
      blockinfile:
        path: /tmp/hosts
        block: |
          127.0.1.1 {{ ansible_hostname }}
      become: true
      tags:
        - desktop

    - name: copy adware+malware hosts file to /etc/hosts
      copy:
        src: /tmp/hosts
        dest: /etc/hosts
      become: true
      tags:
        - desktop

    - name: Create command logs directory
      file:
        path: ~/.logs
        state: directory

    - name: Setup bashrc
      blockinfile:
        path: ~/.bashrc
        block: |
          . /usr/share/autojump/autojump.sh
          HISTTIMEFORMAT="%F %T "
          shopt -s histappend
          HISTSIZE=100000
          HISTFILESIZE=200000
          export PROMPT_COMMAND='if [ "$(id -u)" -ne 0 ]; then echo "$(date "+%Y-%m-%d.%H:%M:%S") $(pwd) $(history 1)" >> ~/.logs/bash-history-$(date "+%Y-%m-%d").log; fi'

    - name: setup Xresources
      template:
        src: xresources
        dest: ~/.Xresources
      tags:
        - desktop

    - name: setup x11 synaptics
      copy:
        src: synaptics-config
        dest: /etc/X11/xorg.conf.d/70-synaptics.conf
      become: yes
      tags:
        - desktop

    - name: setup git
      copy:
        src: git-config
        dest: ~/.gitconfig
